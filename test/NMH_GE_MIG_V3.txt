//========================================================
//========================================================
// 
// TagMapper_Commands.txt for instance: NMH GE FASTMIG
// Ilich R. V3
// 
//========================================================
//LOG ORIGINAL TAGS
//ORIGINAL TagMapper_FASTMIG_060616
//==============================================
//SET DBMISS LOG                  // CREATE LOG ENTRIES FOR MISSES
//SET LOGSIZE 10000               // 1000 ENTRIES = ~ 220MB
//SET DBHIT ANY
set Dbmiss            Ignore
set Verbose 	      True
set Dbhit             Single
set LogAge            3
set LogSize           500000
set SqlDataCache      False
set SqlDataCacheLife  2
set CreateAsReplace   True 
// SET VERBOSE TRUE

//========================================================
// Requirement 0: initialization
// This TM file uses "For all DICOM commands"
//========================================================

Create 7e1f,0001 %DICOM_CMD%
Create 7e1f,0002 %CURRENT_TIME%
Create 7e1f,0003 %DEST_AE_NAME%
Create 7e1f,0004 %SOURCE_AE_NAME%
Create 7e1f,0005 %SOURCE_IP_ADDRESS%
//================================================
//Check for non existant tags
if 0008,0050 != <exists>
Then
     Create 0008,0050 "Acc"
Endif

if 0008,1030 != <exists>
Then
     Create 0008,1030 "Desc"
Endif

if 0010,0020 != <exists>
Then
     Create 0010,0020 "PUID"
Endif

if 0010,0010 != <exists>
Then
     Create 0010,0010 "Name"
Endif

if 0010,0030 != <exists>
Then
     Create 0010,0030 "19890101"
Endif

if 0010,0040 != <exists>
Then
     Create 0010,0040 "Z"
Endif

CREATE 7e1f,0006 0020,000D        //STUDYUID
CREATE 7e1f,0007 0008,0050        //ACCESSION
CREATE 7e1f,0008 0008,1030        //STUDY DESCRIPTION
CREATE 7e1f,0009 0010,0020        //PATIENT ID
CREATE 7e1f,0010 0010,0010        //PATIENT NAME
CREATE 7e1f,0011 0010,0030	  	  //DOB
//CREATE 7e1f,0012 0008,0060	  //MODALITY
CREATE 7e1f,0013 0010,0040        //GENDER

//========================================================
// Requirement 0:
// <Do Not migrate if rejected flag is found in 09031010>
//========================================================
// if 0008,0018 = (REJECTED_SOPUID) ===== this is the original command used
// GE "regected tag" 09031010 = #1#
//if 09031010 = #1# 

if 09031010 = "1"
then
//ModifyTable
//where (REJECTED_SOPUID) = 0008,0018
//   SetColumn (REJECTED_SOPUID_PROCESSED) "1"
//UpdateRow
Fail "REJECTED IMAGE FLAG FOUND in 09031010"
endif 

//==============================================
// Requirement 1:
// Match on SUID, replace ACC#, GENDER, ST_DESC 
set DbTable "TagMapper_FASTMIG_060616"
//==============================================
if 0020000D = (StudyInstanceUID) 
then
replace 0010,0020 (NEW_MRN)
prepend 0010,0020 "00"
replace	0008,0050 (NEW_ACCNUMBER)
//replace 0010,0030 (NEW_DOB)
replace	0010,0040 (NEW_GENDER)
//replace	0010,0010 (NEW_PATIENTNAME)
replace	0008,1030 (NEW_STUDYDESCRIPTION)
//replace 0008,0060 (NEW_MODALITY)
Else
set dbtable "TagMapper_FASTMIG_LOGGING"
ModifyTable
   SetColumn (UNCLEANSED_LOGGED_SUID) = 0020000D
AddRow
endif

//========================================================
// Requirement 2:
// Reconcile patient name based on MRN and DOB match
set DbTable "TagMapper_RECONCILE_PATIENT_NAME"
//========================================================

If    7e1f,0001  = "C-Store Request"
Then
	If    0010,0020  = <EXISTS>
	AndIf 0010,0020 != <NULL>

	AndIf 0010,0030  = <EXISTS>
	AndIf 0010,0030 != <NULL>

	AndIf 0010,0020 = (MRN)
	AndIf 0010,0030 = (DOB)

	Then
		Create 0010,0010 (Name)
	EndIf
EndIf

//======REPLACE MRN if MATCHED NAME/DOB

If    7e1f,0001  = "C-Store Request"
Then
	If    0010,0010  = <EXISTS>
	AndIf 0010,0010 != <NULL>

	AndIf 0010,0030  = <EXISTS>
	AndIf 0010,0030 != <NULL>

	AndIf 0010,0010 = (Name)
	AndIf 0010,0030 = (DOB)

	Then
		Create 0010,0020 (MRN)
	EndIf
EndIf

//==============================================
//  Logging
set dbtable "TagMapper_FASTMIG_LOGGING"
//==============================================
//  1 - Check for existing log entry
//==============================================
if 7e1f0006 = (LOGGED_STUDYUID)
then // Entry exists, don't log
   delete 7e1f,0006 
else
   //===========================================
   // 2 - New study, create log
   //===========================================
   ModifyTable
   SetColumn (LOGGED_STUDYUID)    = 7e1f,0006
   SetColumn (OLD_ACCNUMBER) = 7e1f,0007
   SetColumn (OLD_STUDYDESCRIPTION) = 7e1f,0008
   SetColumn (OLD_MRN) = 7e1f,0009
   SetColumn (OLD_PATIENTNAME) = 7e1f,0010
   SetColumn (OLD_DOB) = 7e1f,0011
   //SetColumn (OLD_MODALITY) = 7e1f,0012
   SetColumn (OLD_GENDER) = 7e1f,0013
   SetColumn (NEW_MRN) = 0010,0020
   SetColumn (NEW_ACCNUMBER) = 0008,0050
   SetColumn (NEW_DOB) = 0010,0030
   SetColumn (NEW_PATIENTNAME) = 0010,0010
   SetColumn (NEW_STUDYDESCRIPTION) = 0008,1030 
   AddRow
   delete 7e1f,0006 
endif